<ng-container *ngIf="assessment && responses.length; else loading">
  <mat-card class="info-card">
    <div class="info-header">
      <div class="user-info">
        <div class="user-name">
          <strong>{{ userInfo.firstName }} {{ userInfo.lastName }}</strong>
          <span class="email">: {{ userInfo.email }}</span>
        </div>
        <div class="assessment-name">
          {{ assessment.name }}
        </div>
      </div>
      <div class="dates">
        Début : {{ assessment.startDate | date: 'dd/MM/yyyy' }} — Fin :
        {{ assessment.endDate | date: 'dd/MM/yyyy' }}
      </div>
    </div>
  </mat-card>

  <mat-divider></mat-divider>

  <!-- Réponses début de la formation -->
  <div *ngIf="getPhaseResponse('avant')" class="section">
    <h2>Réponses début de la formation</h2>
    <div *ngFor="let t of assessment.tasks; let i = index" class="question">
      <p>
        <strong>Q{{ i + 1 }}.</strong> {{ t.description }}
        <span class="q-score-max"> (Score max: {{ getTaskScore(t) }})</span>
      </p>

      <mat-radio-group
        [value]="getSelectedOptionId(getPhaseResponse('avant'), t._id)"
        [disabled]="true"
      >
        <mat-radio-button *ngFor="let o of t.options" [value]="o._id">
          {{ o.text }}
        </mat-radio-button>
      </mat-radio-group>

      <div class="score-line">
        Score (Avant) :
        <strong>{{ getQuestionScore('avant', t) }}</strong>
        / {{ getTaskScore(t) }}
        <mat-icon *ngIf="isCorrect('avant', t)" color="primary"
          >check_circle</mat-icon
        >
        <mat-icon *ngIf="!isCorrect('avant', t)" color="warn">cancel</mat-icon>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Réponses fin de la formation -->
  <div *ngIf="getPhaseResponse('apres')" class="section">
    <h2>Réponses fin de la formation</h2>
    <div *ngFor="let t of assessment.tasks; let i = index" class="question">
      <p>
        <strong>Q{{ i + 1 }}.</strong> {{ t.description }}
        <span class="q-score-max"> (Score max: {{ getTaskScore(t) }})</span>
      </p>

      <mat-radio-group
        [value]="getSelectedOptionId(getPhaseResponse('apres'), t._id)"
        [disabled]="true"
      >
        <mat-radio-button *ngFor="let o of t.options" [value]="o._id">
          {{ o.text }}
        </mat-radio-button>
      </mat-radio-group>

      <div class="score-line">
        Score (Après) :
        <strong>{{ getQuestionScore('apres', t) }}</strong>
        / {{ getTaskScore(t) }}
        <mat-icon *ngIf="isCorrect('apres', t)" color="primary"
          >check_circle</mat-icon
        >
        <mat-icon *ngIf="!isCorrect('apres', t)" color="warn">cancel</mat-icon>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Correction -->
  <div class="section">
    <h2>Correction</h2>
    <div *ngFor="let t of assessment.tasks; let i = index" class="question">
      <p>
        <strong>Q{{ i + 1 }}.</strong> {{ t.description }}
        <span class="q-score-max"> (Score max: {{ getTaskScore(t) }})</span>
      </p>
      <ul>
        <li *ngFor="let o of t.options">
          <mat-icon *ngIf="o.isCorrect">check_circle</mat-icon>
          {{ o.text }}
        </li>
      </ul>
    </div>
  </div>

  <!-- Résumé des scores -->
  <mat-card class="summary-card" style="margin-top: 16px;">
    <h2 style="margin:0 0 12px 0;">Résumé des scores</h2>
    <div class="summary-grid">
      <div class="row">
        <div class="cell label">Score maximum total</div>
        <div class="cell value">{{ maxScore }}</div>
      </div>
      <div class="row">
        <div class="cell label">Avant</div>
        <div class="cell value">
          {{ getTotalScore('avant') }} / {{ maxScore }}
          ({{ getPercent('avant') }}%)
        </div>
      </div>
      <div class="row">
        <div class="cell label">Après</div>
        <div class="cell value">
          {{ getTotalScore('apres') }} / {{ maxScore }}
          ({{ getPercent('apres') }}%)
        </div>
      </div>
    </div>
  </mat-card>

  <div class="actions" style="text-align: center; margin-top: 20px">
    <button mat-raised-button color="primary" (click)="sendResponses()">
      Envoyer PDF des réponses
    </button>
  </div>
</ng-container>

<ng-template #loading>
  <p>Chargement des données…</p>
</ng-template>
