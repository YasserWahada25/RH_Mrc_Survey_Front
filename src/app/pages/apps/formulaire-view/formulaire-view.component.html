<div class="viewport">
  <mat-card class="dialog-scroll">
    <!-- HEADER -->
    <mat-card-header>
      <div class="header-content">
        <div>
          <h1 class="form-title">
            {{ formData.titre || 'Formulaire sans titre' }}
          </h1>
          <p class="form-subtitle" *ngIf="formData.description">
            {{ formData.description }}
          </p>
        </div>
      </div>
    </mat-card-header>

    <!-- CONTENU SCROLLABLE -->
    <mat-card-content>
      <ng-container *ngFor="let sec of sections; let i = index">
        <!-- SECTION HEADER -->
        <div class="section-header">
          <h2 class="section-title">
            {{ sec.titre || 'Section sans titre' }}
          </h2>
          <span class="section-counter">
            Section {{ i + 1 }}/{{ sections.length }}
          </span>
        </div>

        <!-- BOUCLE QUESTIONS -->
        <section
          class="question-block"
          *ngFor="let q of sec.questions; let j = index"
        >
          <div class="question-header">
            <span class="question-number">Q{{ j + 1 }}</span>
            <span class="question-text">
              {{ q.texte || 'Question sans texte' }}
            </span>
          </div>

          <ng-container [ngSwitch]="q.inputType">
            <!-- texte libre -->
            <mat-form-field
              *ngSwitchCase="'texte'"
              appearance="fill"
              class="full-width"
            >
              <mat-label>Votre réponse</mat-label>
              <textarea
                matInput
                [(ngModel)]="answers[q._id]"
                name="txt-{{ q._id }}"
                rows="3"
              ></textarea>
            </mat-form-field>

            <!-- Toggle list -->
            <div *ngSwitchCase="'liste'" class="response-container">
              <mat-button-toggle-group
                [(ngModel)]="answers[q._id]"
                name="tog-{{ q._id }}"
                class="toggle-list"
              >
                <mat-button-toggle
                  *ngFor="let opt of q.options"
                  [value]="opt.label"
                >
                  {{ opt.label }}
                </mat-button-toggle>
              </mat-button-toggle-group>
            </div>

            <!-- Radios -->
            <div *ngSwitchCase="'bouton_radio'" class="response-container">
              <mat-radio-group
                [(ngModel)]="answers[q._id]"
                name="rad-{{ q._id }}"
                class="radio-list"
              >
                <mat-radio-button
                  *ngFor="let opt of q.options"
                  [value]="opt.label"
                >
                  {{ opt.label }}
                </mat-radio-button>
              </mat-radio-group>
            </div>

            <!-- Checkboxes -->
            <div *ngSwitchCase="'case_a_cocher'" class="response-container">
              <div class="checkbox-list">
                <mat-checkbox
                  *ngFor="let opt of q.options"
                  [checked]="answers[q._id]?.includes(opt.label)"
                  (change)="onCheckboxChange(q._id!, opt.label, $event.checked)"
                >
                  {{ opt.label }}
                </mat-checkbox>
              </div>
            </div>

            <!-- Évaluation 1–5
            <div *ngSwitchCase="'evaluation'" class="response-container">
              <div class="scale-container">
                <div class="scale-labels">
                  <span>Pas du tout d'accord</span>
                  <span>Tout à fait d'accord</span>
                </div>
                <mat-radio-group
                  [(ngModel)]="answers[q._id]"
                  name="eval-{{ q._id }}"
                  class="scale-list"
                >
                  <mat-radio-button
                    *ngFor="let n of [1,2,3,4,5]"
                    [value]="n"
                  >
                    {{ n }}
                  </mat-radio-button>
                </mat-radio-group>
              </div>
            </div> -->

            <!-- Évaluation matricielle -->
<div *ngSwitchCase="'evaluation'" class="response-container">
  <table class="eval-table">
    <thead>
      <tr>
        <th></th>
        <th *ngFor="let n of [1,2,3,4,5]">{{ n }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let opt of q.options; let ri = index">
        <!-- Label de la proposition -->
        <td class="eval-label">{{ opt.label }}</td>

        <!-- Radios 1–5 pour chaque ligne -->
        <td *ngFor="let n of [1,2,3,4,5]" class="eval-cell">
          <mat-radio-button
            [name]="'eval-'+q._id+'-'+ri"
            [value]="n"
            [checked]="answers[q._id][ri] === n"
            (change)="onEvalChange(q._id!, ri, n)"
          ></mat-radio-button>
        </td>
      </tr>
    </tbody>
  </table>
</div>


            <!-- Type non supporté -->
            <div *ngSwitchDefault class="unknown-type">
              <mat-icon>error_outline</mat-icon>
              Type de question non supporté
            </div>
          </ng-container>
        </section>

        <!-- Séparateur -->
        <mat-divider
          *ngIf="i < sections.length - 1"
          class="section-divider"
        ></mat-divider>
      </ng-container>
    </mat-card-content>

    <!-- ACTIONS -->
    <mat-card-actions align="end">
      <button mat-stroked-button color="basic" (click)="close()">
        <mat-icon>close</mat-icon> Annuler
      </button>
    </mat-card-actions>
  </mat-card>
</div>
