<h2 mat-dialog-title>Création du formulaire</h2>

<mat-dialog-content class="wizard-content">
  <!-- ETAPE 1 : Nom & description du formulaire -->
  <mat-form-field appearance="outline" class="w-100 mb-2">
    <mat-label>Nom du formulaire</mat-label>
    <input matInput [(ngModel)]="localForm.titre" name="titre" required />
  </mat-form-field>
  <mat-form-field appearance="outline" class="w-100 mb-4">
    <mat-label>Description (facultatif)</mat-label>
    <textarea
      matInput
      [(ngModel)]="localForm.description"
      name="description"
      rows="3"
    ></textarea>
  </mat-form-field>

  <!-- ETAPE 2 : Sections & Questions -->
  <button mat-button color="primary" (click)="addSection()">
    <mat-icon>library_add</mat-icon> Nouvelle section
  </button>

  <div *ngFor="let sec of sections; let si = index" class="section-block">
    <div class="section-header">
      <h3>Section {{ si + 1 }}</h3>
      <button mat-icon-button color="warn" (click)="removeSection(si)">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    <mat-form-field appearance="outline" class="w-100 mb-2">
      <mat-label>Titre section</mat-label>
      <input
        matInput
        [(ngModel)]="sec.titre"
        name="secTitre{{ si }}"
        required
      />
    </mat-form-field>

    <button mat-button color="accent" (click)="addQuestion(si)">
      <mat-icon>add</mat-icon> Ajouter une question
    </button>

    <div *ngFor="let q of sec.questions; let qi = index" class="question-block">
      <div class="question-header">
        <h4>Question {{ qi + 1 }}</h4>
        <button mat-icon-button color="warn" (click)="removeQuestion(si, qi)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>

      <!-- Intitulé -->
      <mat-form-field appearance="outline" class="w-100 mb-1">
        <mat-label>Intitulé</mat-label>
        <input
          matInput
          [(ngModel)]="q.texte"
          name="qTexte{{ si }}_{{ qi }}"
          required
        />
      </mat-form-field>

      <!-- Obligatoire -->
      <mat-checkbox
        [(ngModel)]="q.obligatoire"
        name="qObli{{ si }}_{{ qi }}"
      >
        Obligatoire
      </mat-checkbox>

      <!-- Type -->
      <mat-form-field appearance="outline" class="w-100 mb-2">
        <mat-label>Type</mat-label>
        <mat-select
          [(ngModel)]="q.inputType"
          name="qType{{ si }}_{{ qi }}"
        >
          <mat-option
            *ngFor="let t of inputTypes"
            [value]="t"
          >
            {{ t }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- ===== Propositions & Scores / Évaluation ===== -->
      <!-- 1) Tous les types sauf 'texte' et 'date' -->
      <ng-container *ngIf="q.inputType !== 'texte' && q.inputType !== 'date'">
        
        <!-- A) Pour 'evaluation' : uniquement le label, pas de champ score -->
        <ng-container *ngIf="q.inputType === 'evaluation'">
          <div
            *ngFor="
              let opt of q.options;
              let oi = index
            "
            class="d-flex align-items-center mb-2"
          >
            <mat-form-field
              appearance="outline"
              class="flex-grow-1 me-2"
            >
              <input
                matInput
                placeholder="Texte de la proposition"
                [(ngModel)]="opt.label"
                name="optLabelEval{{ si }}_{{ qi }}_{{ oi }}"
              />
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              (click)="removeOption(si, qi, oi)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <div class="text-end mb-4">
            <button
              mat-mini-fab
              color="primary"
              (click)="addOption(si, qi)"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </ng-container>

        <!-- B) Pour tous les autres types (liste, case_a_cocher, bouton_radio) : label + score -->
        <ng-container *ngIf="q.inputType !== 'evaluation'">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1 font-weight-semibold">Proposition</div>
            <div class="score-col font-weight-semibold">
              Score (0–5)
            </div>
            <div class="action-col"></div>
          </div>
          <mat-divider class="mb-2"></mat-divider>

          <div
            *ngFor="
              let opt of q.options;
              let oi = index
            "
            class="d-flex align-items-center row-cell mb-2"
          >
            <mat-form-field
              appearance="outline"
              class="flex-grow-1 me-2"
            >
              <input
                matInput
                placeholder="Texte"
                [(ngModel)]="opt.label"
                name="optLabel{{ si }}_{{ qi }}_{{ oi }}"
              />
            </mat-form-field>
            <mat-form-field
              appearance="outline"
              class="score-col me-2"
            >
              <input
                matInput
                type="number"
                min="0"
                max="5"
                [(ngModel)]="opt.score"
                name="optScore{{ si }}_{{ qi }}_{{ oi }}"
              />
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              (click)="removeOption(si, qi, oi)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <div class="add-opt text-right">
            <button
              mat-mini-fab
              color="primary"
              (click)="addOption(si, qi)"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="pt-2">
  <button
    mat-flat-button
    color="primary"
    (click)="finish()"
    [disabled]="!localForm.titre.trim()"
  >
    Enregistrer
  </button>
  <button mat-stroked-button color="warn" (click)="cancel()">
    Annuler
  </button>
</mat-dialog-actions>
