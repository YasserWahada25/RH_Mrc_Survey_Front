<!-- src/app/pages/apps/formulaire-edit/formulaire-edit.component.html -->
<mat-card class="formulaire-edit-card">
  <mat-card-header>
    <mat-card-title>Édition du formulaire</mat-card-title>
  </mat-card-header>

  <mat-card-content class="mat-typography dialog-scroll">
    <!-- ===== Formulaire lui-même ===== -->
    <mat-form-field appearance="outline" class="w-100">
      <mat-label>Titre *</mat-label>
      <input
        matInput
        [(ngModel)]="formData.titre"
        name="titre"
        required
      />
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-100 mt-3">
      <mat-label>Description</mat-label>
      <textarea
        matInput
        [(ngModel)]="formData.description"
        name="description"
        rows="3"
      ></textarea>
    </mat-form-field>

    <mat-divider class="my-4"></mat-divider>

    <!-- ===== Sections + Questions ===== -->
    <div *ngFor="let sec of sections; let i = index" class="mb-4">
      <!-- Titre de la section -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Section {{ i + 1 }} – Titre</mat-label>
        <input
          matInput
          [(ngModel)]="sec.titre"
          name="secTitre{{ i }}"
          (blur)="updateSection(sec)"
          required
        />
      </mat-form-field>

      <!-- Questions -->
      <div *ngFor="let q of sec.questions; let j = index" class="ps-3 mb-4">
        <!-- Texte de la question -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Q{{ j + 1 }} – Texte</mat-label>
          <input
            matInput
            [(ngModel)]="q.texte"
            name="qTexte{{ i }}{{ j }}"
            (blur)="updateQuestion(q)"
            required
          />
        </mat-form-field>

        <!-- Obligatoire -->
        <mat-checkbox
          class="d-block mb-2"
          [(ngModel)]="q.obligatoire"
          name="qOblig{{ i }}{{ j }}"
          (change)="updateQuestion(q)"
        >
          Obligatoire
        </mat-checkbox>

        <!-- Sélecteur de type -->
        <mat-form-field appearance="outline" class="ms-3 mb-3">
          <mat-label>Type</mat-label>
          <mat-select
            [(ngModel)]="q.inputType"
            name="qType{{ i }}{{ j }}"
            (selectionChange)="updateQuestion(q)"
          >
            <mat-option *ngFor="let t of inputTypes" [value]="t">
              {{ t }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- ===== 1) ÉVALUATION (seulement labels) ===== -->
        <ng-container *ngIf="q.inputType === 'evaluation'" class="ps-3 mb-4">
          <div
            *ngFor="let opt of q.options; let oi = index"
            class="d-flex align-items-center mb-2"
          >
            <mat-form-field appearance="outline" class="flex-grow-1 me-2">
              <input
                matInput
                placeholder="Texte de la proposition"
                [(ngModel)]="opt.label"
                name="optLabelEval{{ i }}_{{ j }}_{{ oi }}"
                (blur)="updateQuestion(q)"
              />
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              (click)="removeOption(q, oi)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <div class="text-end">
            <button
              mat-mini-fab
              color="primary"
              (click)="addOption(q)"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </ng-container>

        <!-- ===== 2) PROPOSITIONS & SCORES (autres types) ===== -->
        <ng-container
          *ngIf="
            q.inputType !== 'texte'
            && q.inputType !== 'date'
            && q.inputType !== 'evaluation'
          "
        >
          <div class="d-flex align-items-center mb-1">
            <div class="flex-grow-1"><strong>Proposition</strong></div>
            <div class="px-2"><strong>Score</strong></div>
            <div class="px-2"></div>
          </div>

          <div
            *ngFor="let opt of q.options; let oi = index"
            class="d-flex align-items-center mb-2"
          >
            <mat-form-field appearance="outline" class="flex-grow-1 me-2">
              <input
                matInput
                placeholder="Texte de la proposition"
                [(ngModel)]="opt.label"
                name="optLabel{{ i }}_{{ j }}_{{ oi }}"
                (blur)="updateQuestion(q)"
              />
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="me-2"
              style="width: 80px"
            >
              <input
                matInput
                type="number"
                min="0"
                max="5"
                [(ngModel)]="opt.score"
                name="optScore{{ i }}_{{ j }}_{{ oi }}"
                (blur)="updateQuestion(q)"
              />
            </mat-form-field>

            <button
              mat-icon-button
              color="warn"
              (click)="removeOption(q, oi)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="text-end">
            <button
              mat-mini-fab
              color="primary"
              (click)="addOption(q)"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </ng-container>
      </div>
    </div>
  </mat-card-content>

  <!-- Actions générales -->
  <mat-card-actions align="end">
    <button mat-stroked-button (click)="cancel()">Annuler</button>
    <button
      mat-flat-button
      color="primary"
      (click)="save()"
      [disabled]="!formData.titre?.trim()"
    >
      Enregistrer
    </button>
  </mat-card-actions>
</mat-card>
