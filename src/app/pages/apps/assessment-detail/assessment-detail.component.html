<mat-card class="assessment-card" *ngIf="assessment">
  <mat-card-content>
    <!-- ðŸ§  EN-TÃŠTE -->
    <div class="assessment-header">
      <h1 class="assessment-title">{{ assessment.name }}</h1>
      <p class="assessment-type">
        Type : {{ assessment.type === 'normal' ? 'Normal' : 'Avant / AprÃ¨s' }}
      </p>

      <ng-container *ngIf="assessment.type === 'avant_apres' && assessment.startDate && assessment.endDate">
        <p class="assessment-dates">
          ðŸ“… Formation : du {{ assessment.startDate | date: 'dd/MM/yyyy' }} au
          {{ assessment.endDate | date: 'dd/MM/yyyy' }}
        </p>
      </ng-container>

      <ng-container *ngIf="!adminMode && (phase === 'avant' || phase === 'apres')">
        <p class="assessment-phase">Phase : Â«{{ phase | titlecase }}Â»</p>
      </ng-container>
    </div>

    <!-- ðŸ‘¨â€ðŸ’¼ MODE ADMIN -->
    <ng-container *ngIf="adminMode; else userForm">
      <!-- ========== Envoi par email ========== -->
      <div class="section">
        <h3>Invitations</h3>

        <!-- 1) Premier envoi : PHASE AVANT -->
        <div class="invite-block">
          <div class="invite-title">1) Phase AVANT</div>
          <button mat-raised-button color="accent" (click)="sendPhaseAvant()">
            Envoyer invitations (phase AVANT)
          </button>
        </div>

        <!-- 2) DeuxiÃ¨me envoi : PHASE APRÃˆS (liste + âœ…) -->
        <div class="invite-block" *ngIf="assessment.type === 'avant_apres'">
          <div class="invite-title">
            2) Phase APRÃˆS
            <span class="hint">(aux mÃªmes emails que la phase AVANT)</span>
          </div>

          <div *ngIf="loadingInvitees">Chargement des destinatairesâ€¦</div>
          <div *ngIf="!loadingInvitees && !inviteesAvant.length" class="muted">
            Aucune invitation envoyÃ©e pour la phase AVANT pour le moment.
          </div>

          <ul class="emails-list" *ngIf="inviteesAvant.length">
            <li *ngFor="let it of inviteesAvant">
              <span class="status">{{ it.hasAvant ? 'âœ…' : 'â€¢' }}</span>
              <span class="email">{{ it.email }}</span>
            </li>
          </ul>

          <button
            mat-raised-button
            color="primary"
            (click)="sendPhaseApres()"
            [disabled]="!inviteesAvant.length"
          >
            Envoyer invitations (phase APRÃˆS)
          </button>
        </div>
      </div>

      <!-- AperÃ§u questions (lecture seule) -->
      <div class="questions-list">
        <ng-container *ngFor="let t of assessment.tasks; let i = index">
          <mat-card class="question-card">
            <mat-card-header>
              <mat-card-title>Q{{ i + 1 }}. {{ t.description }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-radio-group [disabled]="true" class="options-group">
                <mat-radio-button *ngFor="let o of t.options" [value]="o._id">
                  {{ o.text }}
                </mat-radio-button>
              </mat-radio-group>
            </mat-card-content>
          </mat-card>
        </ng-container>
      </div>
    </ng-container>

    <!-- ðŸ‘¤ MODE UTILISATEUR -->
    <ng-template #userForm>
      <form (ngSubmit)="onSubmit()">
        <div class="questions-list">
          <ng-container *ngFor="let t of assessment.tasks; let i = index">
            <mat-card class="question-card">
              <mat-card-header>
                <mat-card-title>Q{{ i + 1 }}. {{ t.description }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-radio-group
                  [(ngModel)]="answers[t._id]"
                  name="ans{{ i }}"
                  class="options-group"
                  [disabled]="disabledForm"
                >
                  <!-- â—ï¸ on envoie l'ID de l'option -->
                  <mat-radio-button *ngFor="let o of t.options" [value]="o._id">
                    {{ o.text }}
                  </mat-radio-button>
                </mat-radio-group>
              </mat-card-content>
            </mat-card>
          </ng-container>
        </div>
        <div class="submit-container">
          <button mat-raised-button color="primary" type="submit" [disabled]="disabledForm">
            Soumettre
          </button>
        </div>
      </form>
    </ng-template>
  </mat-card-content>
</mat-card>
